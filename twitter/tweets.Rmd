---
title: "twitter code"
author: "Janna Ramadan"
date: "11/2/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(rtweet)
library(tidytext)
library(dplyr)
library(ggplot2)
library(readr)
library(gganimate)
library(shiny)
library(textdata)
```


```{r}
appname <- "muslimopinion"
  
key <- "nTjL6wXzSH6m0A0NWaYOqJ7qH76Y8q01Jaa1YNujCdjAjk4poQ"

secretkey <- "nTjL6wXzSH6m0A0NWaYOqJ7qH76Y8q01Jaa1YNujCdjAjk4poQ"

muslim_extremist_search_string <- c("muslim extremist", "muslim terrorist", "muslim radical")

# muslim only tweets
muslim_tweets <- search_tweets(type = "recent", 
                                       q = "muslim",
                               n = 1000, 
                               include_rts = FALSE,
                               "lang:en",
                               geocode = lookup_coords("usa"))  %>%
  select("created_at", "text", "hashtags")

  saveRDS(muslim_tweets, file = paste0("muslim_tweets_",Sys.Date(),".RDS"))
  
# Muslim, Arab, South Asian Tweets
  muslim_arab_southasian_tweets <- search_tweets(type = "recent", 
                                       q = "arab OR south asian",
                               n = 1000, 
                               include_rts = FALSE,
                               "lang:en",
                               geocode = lookup_coords("usa"))  %>%
  select("created_at", "text", "hashtags")

  saveRDS(muslim_arab_southasian_tweets, file = paste0("muslim_arab_southasian_tweets_",Sys.Date(),".RDS"))
  

# Islam tweets
islam_tweets <- search_tweets(type = "recent", 
                                       q = "islam",
                               n = 1000, 
                               include_rts = FALSE,
                               "lang:en",
                               geocode = lookup_coords("usa"))  %>%
  select("created_at", "text", "hashtags")

  saveRDS(islam_tweets, file = paste0("islam_tweets_",Sys.Date(),".RDS"))
  
# Anti-democratic tweets
antidem_tweets <- search_tweets(type = "recent", 
                                       q = "anti-democratic",
                               n = 1000, 
                               include_rts = FALSE,
                               "lang:en",
                               geocode = lookup_coords("usa"))  %>%
  select("created_at", "text", "hashtags")

  saveRDS(antidem_tweets, file = paste0("antidem_tweets_",Sys.Date(),".RDS"))

```

```{r}

# don't run every time

filelist <- tweets <- list.files(pattern = "*.RDS")

#i in = sets lengths of i; how many files to bound them all

tweeteater <- function(filelist) {
  for(i in 1:length(filelist)){
  subfile = readRDS(filelist[i]) %>%
    mutate(dataset = filelist[i])
    if(i == 1){
      final <- subfile 
    }
    if(i > 1) {
      final <- bind_rows(final, subfile)
    }
  } 
  
  return(final)
  
}

tweetfile <- tweeteater(filelist) %>%
  mutate(date = as.Date(created_at)) %>%
  mutate(filename = str_extract(dataset, ".*(?=_2)"))

# used ? lookahead to get everything before _2 in _2020...

```

```{r, unique word counts}
# for front page - will show the common/unique words that come with each
# twitter search

# Remmoves http elements 
tweetfile$stripped_text <- gsub("http\\S+", 
                                  "",
                                 tweetfile$text)

# converts the tweets into lowercase, removes punctuation, and adds an id for
# each tweet.
# Also removes "stop words" which are words like I, being, have, etc. 
# They are words not useful in sentiment analysis

tweetfile_clean_muslim <- tweetfile %>%
  filter(filename == "muslim_tweets") %>%
  select(stripped_text) %>%
  unnest_tokens(word, stripped_text) %>%
  anti_join(stop_words)

tweetfile_clean_arab_sa <- tweetfile %>%
  filter(filename == "muslim_arab_southasian_tweets") %>%
  select(stripped_text) %>%
  unnest_tokens(word, stripped_text) %>%
  anti_join(stop_words)

tweetfile_clean_islam <- tweetfile %>%
    filter(filename == "islam_tweets") %>%
  select(stripped_text) %>%
  unnest_tokens(word, stripped_text) %>%
  anti_join(stop_words)

tweetfile_clean_antidem <- tweetfile %>%
    filter(filename == "antidem_tweets") %>%
  select(stripped_text) %>%
  unnest_tokens(word, stripped_text) %>%
  anti_join(stop_words)

tweetfile_clean <- tweetfile %>%
  select(stripped_text) %>%
  unnest_tokens(word, stripped_text) %>%
  anti_join(stop_words)

tweetfile_clean_ethnic <- tweetfile %>%
  filter(filename == c("muslim_tweets", "islam_tweets", "muslim_arab_southasian_tweets")) %>%
  select(stripped_text) %>%
  unnest_tokens(word, stripped_text) %>%
  anti_join(stop_words)

# Can see top tweets with this code head(tweetfile_clean_muslim)
# First look - muslim tweets shows words like hate, condemnation, 
# jihadwatchers, leaving. and taught. The arab & south asian data and islam
# data came up with less conclusive data and words that do not have direct
# ties to islam. antidem data is clearly impacted by the election because 
# repubican and trump were some of the top words.

```

```{r, top 10 words }
# The following graphs have the same format. They look at the top 10 most
# frequent words in the data sets. 

tweetfile_clean_muslim %>%
  count(word, sort = TRUE) %>%
  top_n(20) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(mapping = aes(x = word, y = n)) +
  geom_col() +
  xlab(NULL) +
  coord_flip() +
  theme_minimal() +
  labs(title = "Top 10 Most Frequent Words In Tweets Including \nthe Word 'Muslim'",
       subtitle = "Tweets gathered Nov. 3 - Nov. 17, 2020",
       caption = "Source: Twitter", 
       x = "Count",
       y = "Unique Words")

tweetfile_clean_arab_sa %>%
  count(word, sort = TRUE) %>%
  top_n(20) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(mapping = aes(x = word, y = n)) +
  geom_col() +
  xlab(NULL) +
  coord_flip() +
  theme_minimal() +
  labs(title = "Top 10 Most Frequent Words In Tweets Including \nthe Word 'Arab' and 'South Asian",
       subtitle = "Tweets gathered Nov. 3 - Nov. 17, 2020",
       caption = "Source: Twitter", 
       x = "Count",
       y = "Unique Words")

# Key words clearly tied to election

tweetfile_clean_islam %>%
  count(word, sort = TRUE) %>%
  top_n(20) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(mapping = aes(x = word, y = n)) +
  geom_col() +
  xlab(NULL) +
  coord_flip() +
  theme_minimal() +
  labs(title = "Top 10 Most Frequent Words In Tweets Including \nthe Word 'Islam'",
       subtitle = "Tweets gathered Nov. 3 - Nov. 17, 2020",
       caption = "Source: Twitter", 
       x = "Count",
       y = "Unique Words")

# surprisingly peaceful

tweetfile_clean_antidem %>%
  count(word, sort = TRUE) %>%
  top_n(20) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(mapping = aes(x = word, y = n)) +
  geom_col() +
  xlab(NULL) +
  coord_flip() +
  theme_minimal() +
  labs(title = "Top 10 Most Frequent Words In Tweets Including \nthe Word 'Anti-Democratic'",
       subtitle = "Tweets gathered Nov. 3 - Nov. 17, 2020",
       caption = "Source: Twitter", 
       x = "Count",
       y = "Unique Words")

# Again, heavily influenced by the election

tweetfile_clean %>%
  count(word, sort = TRUE) %>%
  top_n(20) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(mapping = aes(x = word, y = n)) +
  geom_col(fill = "slategray2") +
  xlab(NULL) +
  coord_flip() +
  theme_minimal() +
  labs(title = "Top 10 Most Frequent Words Across Tweets Including \nthe Words 'Muslim, 'Islam', 'Arab', 'South Asian', and 'Anti-Democratic",
       subtitle = "Tweets gathered Nov. 3 - Nov. 17, 2020",
       caption = "Source: Twitter", 
       x = "Count",
       y = "Unique Words")
# Anti is the top, but it is weighted by anti-democratic. Clearly impacted by
# the election results and Kamala Harris, the VP-elect

tweetfile_clean_ethnic %>%
  count(word, sort = TRUE) %>%
  top_n(20) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(mapping = aes(x = word, y = n)) +
  geom_col() +
  xlab(NULL) +
  coord_flip() +
  theme_minimal() +
  labs(title = "Top 10 Most Frequent Words Across Tweets Including \nthe Words 'Muslim, 'Islam', 'Arab', and 'South Asian'",
       subtitle = "Tweets gathered Nov. 3 - Nov. 17, 2020",
       caption = "Source: Twitter", 
       x = "Count",
       y = "Unique Words")

# Shows that anti-democratic did heavily weigh on the word anti-
```

```{r, sentiment analysis muslim}
# Used bing analysis - which counts positive and negative words. Trump is coded as positive. 


tweet_muslim_sentiment <- tweetfile_clean_muslim %>%
  inner_join(get_sentiments("bing")) %>%
  count(word, sentiment, sort = TRUE) %>%
  ungroup()

tweet_muslim_sentiment %>%
  group_by(sentiment) %>%
  top_n(20) %>%
  ungroup() %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(mapping = aes(x = word, y = n, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~sentiment, scale = "free_y")+
  labs(title = "Sentiment In Tweets Including the Word 'Muslim'", 
       subtitle = "Tweets gathered Nov. 3 - Nov. 17, 2020",
       caption = "Source: Twitter", 
       x = " ",
       y = "Contribution to Sentiment") +
  coord_flip() +
  theme_bw() +
  theme(text = element_text(family = "Palatino")) +
  scale_fill_manual(values = c("brown2", "olivedrab3")) 
  
```

```{r, sentiment analysis islam}
# Used bing analysis - which counts positive and negative words. Trump is coded as positive. 

tweet_islam_sentiment <- tweetfile_clean_islam %>%
  inner_join(get_sentiments("bing")) %>%
  count(word, sentiment, sort = TRUE) %>%
  ungroup()

tweet_islam_sentiment %>%
  group_by(sentiment) %>%
  top_n(20) %>%
  ungroup() %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(mapping = aes(x = word, y = n, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~sentiment, scale = "free_y")+
  labs(title = "Sentiment In Tweets Including the Word 'Islam'", 
       subtitle = "Tweets gathered Nov. 3 - Nov. 17, 2020",
       caption = "Source: Twitter", 
       x = " ",
       y = "Contribution to Sentiment") +
  coord_flip() +
  theme_bw() +
  theme(text = element_text(family = "Palatino")) +
  scale_fill_manual(values = c("brown2", "olivedrab3")) 
```

```{r, sentiment analysis arab and south asian}
# Used bing analysis - which counts positive and negative words. Trump is coded as positive. 

tweet_arab_sa_sentiment <- tweetfile_clean_arab_sa %>%
  inner_join(get_sentiments("bing")) %>%
  count(word, sentiment, sort = TRUE) %>%
  ungroup()

tweet_arab_sa_sentiment %>%
  group_by(sentiment) %>%
  top_n(20) %>%
  ungroup() %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(mapping = aes(x = word, y = n, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~sentiment, scale = "free_y")+
  labs(title = "Sentiment In Tweets Including the Words 'Arab' and 'South Asian'", 
       subtitle = "Tweets gathered Nov. 3 - Nov. 17, 2020",
       caption = "Source: Twitter", 
       x = " ",
       y = "Contribution to Sentiment") +
  coord_flip() +
  theme_bw() +
  theme(text = element_text(family = "Palatino")) +
  scale_fill_manual(values = c("brown2", "olivedrab3")) 
```

```{r, sentiment analysis anti-dem}
# Used bing analysis - which counts positive and negative words. Trump is coded as positive. 

tweet_antidem_sentiment <- tweetfile_clean_antidem %>%
  inner_join(get_sentiments("bing")) %>%
  count(word, sentiment, sort = TRUE) %>%
  ungroup()

tweet_antidem_sentiment %>%
  group_by(sentiment) %>%
  top_n(20) %>%
  ungroup() %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(mapping = aes(x = word, y = n, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~sentiment, scale = "free_y")+
  labs(title = "Sentiment In Tweets Including the Words 'Anti-Democratic'", 
       subtitle = "Tweets gathered Nov. 3 - Nov. 17, 2020",
       caption = "Source: Twitter", 
       x = " ",
       y = "Contribution to Sentiment") +
  coord_flip() +
  theme_bw() +
  theme(text = element_text(family = "Palatino")) +
  scale_fill_manual(values = c("brown2", "olivedrab3")) 

```

```{r, sentiment analysis aggregate}
# Used bing analysis - which counts positive and negative words. Trump is coded as positive. 

tweet_aggregate_sentiment <- tweetfile_clean %>%
  inner_join(get_sentiments("bing")) %>%
  count(word, sentiment, sort = TRUE) %>%
  ungroup()

tweet_aggregate_sentiment %>%
  group_by(sentiment) %>%
  top_n(20) %>%
  ungroup() %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(mapping = aes(x = word, y = n, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~sentiment, scale = "free_y")+
  labs(title = "Sentiment In Tweets Including the Words 'Muslim, 'Islam', 'Arab', 'South Asian', and 'Anti-Democratic'", 
       subtitle = "Tweets gathered Nov. 3 - Nov. 17, 2020",
       caption = "Source: Twitter", 
       x = " ",
       y = "Contribution to Sentiment") +
  coord_flip() +
  theme_bw() +
  theme(text = element_text(family = "Palatino")) +
  scale_fill_manual(values = c("brown2", "olivedrab3")) 


```

```{r, sentiment analysis aggregate ethnic}
# Used bing analysis - which counts positive and negative words. Trump is coded as positive. 

tweet_ethnic_sentiment <- tweetfile_clean_ethnic %>%
  inner_join(get_sentiments("bing")) %>%
  count(word, sentiment, sort = TRUE) %>%
  ungroup()

tweet_ethnic_sentiment %>%
  group_by(sentiment) %>%
  top_n(20) %>%
  ungroup() %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(mapping = aes(x = word, y = n, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~sentiment, scale = "free_y") +
  labs(title = "Sentiment In Tweets Including the Words 'Muslim, 'Islam', 'Arab', and 'South Asian'", 
       subtitle = "Tweets gathered Nov. 3 - Nov. 17, 2020",
       caption = "Source: Twitter", 
       x = " ",
       y = "Contribution to Sentiment") +
  coord_flip() +
  theme_bw() +
  theme(text = element_text(family = "Palatino")) +
  scale_fill_manual(values = c("brown2", "olivedrab3")) 


```

```{r, sentiment numerical}

# Afinn creates a a numerical spectrum of values for sentiment. 0 is neutral. 
# Positive values are postive sentiments.
# Negative values are negative sentiments. 

# Numerical spectrum with tweets including the word Muslim
tweet_muslim_sentiment %>%
  inner_join(get_sentiments("afinn")) %>%
  ggplot(mapping = aes(x = value)) +
  geom_histogram(bins = 30, fill = "lightskyblue") +
  ylim(0, 500) +
  labs(title = "Numerical Scale of Sentiment in Tweets Including the Word 'Muslim'", 
       subtitle = "Tweets gathered Nov. 3 - Nov. 17, 2020",
       caption = "Source: Twitter", 
       x = "Score",
       y = "Count") +
  theme_bw() +
  theme(text = element_text(family = "Palatino")) 

# Numerical spectrum with tweets including the word Islam

tweet_islam_sentiment %>%
  inner_join(get_sentiments("afinn")) %>%
  ggplot(mapping = aes(x = value)) +
  geom_histogram(bins = 30, fill = "lightskyblue") +
  ylim(0, 500) +
  labs(title = "Numerical Scale of Sentiment in Tweets Including the Word 'Islam'", 
       subtitle = "Tweets gathered Nov. 3 - Nov. 17, 2020",
       caption = "Source: Twitter", 
       x = "Score",
       y = "Count") +
  theme_bw() +
  theme(text = element_text(family = "Palatino"))  

# Numerical spectrum with tweets including the words Arab and South Asian

tweet_arab_sa_sentiment %>%
  inner_join(get_sentiments("afinn")) %>%
  ggplot(mapping = aes(x = value)) +
  geom_histogram(bins = 30, fill = "lightskyblue") +
  ylim(0, 500) +
  labs(title = "Numerical Scale of Sentiment in Tweets Including the Words 'Arab' and 'South Asian'", 
       subtitle = "Tweets gathered Nov. 3 - Nov. 17, 2020",
       caption = "Source: Twitter", 
       x = "Score",
       y = "Count") +
  theme_bw() +
  theme(text = element_text(family = "Palatino"))  

# Numerical spectrum with tweets including the word Anti-Democratic

tweet_antidem_sentiment %>%
  inner_join(get_sentiments("afinn")) %>%
  ggplot(mapping = aes(x = value)) +
  geom_histogram(bins = 30, fill = "lightskyblue") + 
  ylim(0, 500) +
  labs(title = "Numerical Scale of Sentiment in Tweets Including the Word 'Anti-Democratic'", 
       subtitle = "Tweets gathered Nov. 3 - Nov. 17, 2020",
       caption = "Source: Twitter", 
       x = "Score",
       y = "Count") +
  theme_bw() +
  theme(text = element_text(family = "Palatino"))  

# Numerical spectrum with tweets including the words Muslim, Islam, Arab, 
# and South Asian

tweet_ethnic_sentiment %>%
  inner_join(get_sentiments("afinn")) %>%
  ggplot(mapping = aes(x = value)) +
  geom_histogram(bins = 30, fill = "lightskyblue") +
  ylim(0, 500) +
  labs(title = "Numerical Scale of Sentiment in Tweets Including the Words 'Muslim', 'Islam', 'Arab, and 'South Asian'", 
       subtitle = "Tweets gathered Nov. 3 - Nov. 17, 2020",
       caption = "Source: Twitter", 
       x = "Score",
       y = "Count") +
  theme_bw() +
  theme(text = element_text(family = "Palatino")) 

# Numerical spectrum with tweets including the word Muslim, Islam, Arab, 
#  South Asian, and Anti-Democratic - my aggregate data

tweet_aggregate_sentiment %>%
  inner_join(get_sentiments("afinn")) %>%
  ggplot(mapping = aes(x = value)) +
  geom_histogram(bins = 30, fill = "lightskyblue") +
  ylim(0, 500) +
  labs(title = "Numerical Scale of Sentiment in Tweets Including the Words 'Muslim', 'Islam', 'Arab, 'South Asian', and 'Anti-Democratic'", 
       subtitle = "Tweets gathered Nov. 3 - Nov. 17, 2020",
       caption = "Source: Twitter", 
       x = "Score",
       y = "Count") +
  theme_bw() +
  theme(text = element_text(family = "Palatino"))  

```

```{r, write csv for data imported to shiny}

write_csv(tweetfile_clean, "tweetfile_clean.csv")
write_csv(tweetfile_clean_muslim, "tweetfile_clean_muslim.csv")
write_csv(tweetfile_clean_islam, "tweetfile_clean_islam.csv")
write_csv(tweetfile_clean_arab_sa, "tweetfile_clean_arab_sa.csv")
write_csv(tweetfile_clean_antidem, "tweetfile_clean_antidem.csv")
write_csv(tweetfile_clean_ethnic, "tweetfile_clean_ethnic.csv")

write_csv(tweet_muslim_sentiment, "tweetfile_muslim_sentiment.csv")
write_csv(tweet_islam_sentiment, "tweetfile_islam_sentiment.csv")
write_csv(tweet_arab_sa_sentiment, "tweetfile_arab_sa_sentiment.csv")
write_csv(tweet_antidem_sentiment, "tweetfile_antidem_sentiment.csv")
write_csv(tweet_ethnic_sentiment, "tweetfile_ethnic_sentiment.csv")
write_csv(tweet_aggregate_sentiment, "tweetfile_aggregate_sentiment.csv")
```

